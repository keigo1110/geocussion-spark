id: core_refactor
title: "åŸºç›¤ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°: å‹å®šç¾©çµ±åˆã¨ä¾å­˜æ•´ç†"
description: |
  `src/input` ç³»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ç™ºç”Ÿã—ã¦ã„ã‚‹å‹ã‚¯ãƒ©ã‚¹é‡è¤‡ã¨ã€`pyorbbecsdk` ã®ãƒ­ãƒ¼ã‚«ãƒ«é…ç½®ã«ã‚ˆã‚‹ import è¡çªã‚’è§£æ¶ˆã—ã€
  ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å…¨ä½“ã®ä¿å®ˆæ€§ãƒ»ç’°å¢ƒå†ç¾æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚
implementation_summary: |
  âœ… å®Ÿè£…å®Œäº† (2025-01-30): 
  - å‹å®šç¾©çµ±åˆ: CameraIntrinsics, FrameData, HandednessTypeç­‰ã‚’src/types.pyã«çµ±åˆ
  - pyorbbecsdkåå‰è¡çªå›é¿: vendor namespaceã«ç§»å‹•
  - ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°åˆ†é¡: OBError/OpenCV/ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã§åˆ†é›¢ã€è‡´å‘½ä¾‹å¤–ã¯å†raise
  - printâ†’loggerç½®æ›: 28ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹ã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡å¯èƒ½
  - ãƒ¡ãƒƒã‚·ãƒ¥ã‚°ãƒªãƒƒãƒ‰é‡è¤‡å‰Šé™¤: æ—¢ã«æœ€é©åŒ–æ¸ˆã¿
  ğŸ“‹ æ®‹ã‚¿ã‚¹ã‚¯: requirements.txtæ›´æ–°ã€READMEè¨˜è¼‰
problems:
  - id: P-CORE-001
    title: "CameraIntrinsics / FrameData ãŒå¤šé‡å®šç¾©"
    module: ["src/types.py", "src/input/stream.py", "src/input/pointcloud.py"]
    description: |
      ç¾åœ¨ `CameraIntrinsics` ã¨ `FrameData` ãŒ `src/types.py` ã¨ `src/input/stream.py` ã®åŒæ–¹ã§å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€
      å°†æ¥çš„ã«å‹ã®ä»•æ§˜ãŒä¹–é›¢ã™ã‚‹ãƒªã‚¹ã‚¯ãŒé«˜ã„ã€‚IDE ã®å‹è§£æ±ºã‚„ mypy æ¤œè¨¼ã§ã‚‚æ··ä¹±ã‚’æ‹›ãã€‚
    severity: "High"
    fix_suggestion: |
      `src/types.py` ã«ä¸€æœ¬åŒ–ã—ã€ä»–ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯åŒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ import ã—ã¦åˆ©ç”¨ã™ã‚‹ã€‚
  - id: P-CORE-002
    title: "pyorbbecsdk ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®äºŒé‡å®šç¾©"
    module: "pyorbbecsdk/"
    description: |
      ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç›´æ¥é…ç½®ã—ã¦ã„ã‚‹ãŸã‚ã€`pip install pyorbbecsdk` ã¨åå‰è¡çªãŒç™ºç”Ÿã™ã‚‹ã€‚
      é–‹ç™ºç’°å¢ƒã«ã‚ˆã£ã¦æ¨™æº–ãƒ‘ã‚¹ãŒå„ªå…ˆã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã€ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§æŒ™å‹•ãŒå¤‰ã‚ã‚‹ã€‚
    severity: "High"
    fix_suggestion: |
      - ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ– or è‡ªå‰ wheel é…å¸ƒã«åˆ‡ã‚Šæ›¿ãˆã€‚
      - ãƒªãƒã‚¸ãƒˆãƒªå†…ã§ã¯ import å…ˆã‚’ `vendor.pyorbbecsdk` ãªã©ã«ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹éš”é›¢ã™ã‚‹ã€‚
  - id: P-CORE-003
    title: "ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒ catch-all"
    module: ["src/input/stream.py", "src/input/pointcloud.py"]
    description: |
      `except Exception:` ã§å…¨ã¦æ¡ã‚Šæ½°ã—ã¦ãŠã‚Šã€è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ãŒä¸Šä½ã«ä¼æ¬ã—ãªã„ã€‚ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£ã€‚
    severity: "Medium"
    fix_suggestion: |
      - SDK ä¾‹å¤– (`OBError`) / ä¸€èˆ¬ä¾‹å¤– / è‡´å‘½ä¾‹å¤– ã§æ•æ‰ã‚’åˆ†é›¢ã€‚
      - è‡´å‘½ä¾‹å¤–ã¯å† raise ã—ã¦å‘¼ã³å‡ºã—å´ã«é€šçŸ¥ã™ã‚‹ã€‚
  - id: P-CORE-004
    title: "print ãƒ™ãƒ¼ã‚¹ã®ãƒ­ã‚°æ··åœ¨"
    module: ["src/input/pointcloud.py", "src/input/depth_filter.py"]
    description: |
      `print()` ãŒ logger ã¨ä½µç”¨ã•ã‚Œã¦ãŠã‚Šã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡ãŒã§ããªã„ã€‚
    severity: "Low"
    fix_suggestion: |
      å…¨ã¦ `get_logger(__name__)` ã«çµ±ä¸€ã—ã€`logger.debug/info/warning` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
  - id: P-CORE-005
    title: "ãƒ¡ãƒƒã‚·ãƒ¥ã‚°ãƒªãƒƒãƒ‰è¨ˆç®—ã®é‡è¤‡"
    module: "src/input/pointcloud.py"
    description: |
      `_precompute_meshgrid` ã¨ `_precompute_coefficients` ãŒå®Ÿè³ªåŒã˜è¨ˆç®—ã‚’é‡è¤‡å®Ÿè¡Œã—ã€
      ãƒ¡ãƒ¢ãƒªã¨åˆæœŸåŒ–æ™‚é–“ã‚’æµªè²»ã—ã¦ã„ã‚‹ã€‚
    severity: "Low"
    fix_suggestion: |
      ã©ã¡ã‚‰ã‹ä¸€ã¤ã«çµ±åˆã—ã€lazy-init ã§ä¸€åº¦ã ã‘è¨ˆç®—ã™ã‚‹ã€‚

tasks:
  - id: T-CORE-001
    description: "`src/types.py` ã«å‹å®šç¾©ã‚’çµ±åˆã—ã€å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°"
    depends_on: [P-CORE-001]
    steps:
      - "âœ… 1. `CameraIntrinsics`, `FrameData` ã‚’ `src/types.py` ã¸é›†ç´„ã€‚"
      - "âœ… 2. `src/input/stream.py` ã¨ `src/input/pointcloud.py` ã‹ã‚‰é‡è¤‡å®šç¾©ã‚’å‰Šé™¤ã€‚"
      - "âœ… 3. import æ–‡ã‚’ `from src.types import CameraIntrinsics, FrameData` ã«çµ±ä¸€ã€‚"
    acceptance_criteria:
      - "âœ… é‡è¤‡å®šç¾©ãŒç„¡ããªã‚Šã€mypy strict ãŒå‹é‡è¤‡ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã•ãªã„ã€‚"
    status: "COMPLETED"

  - id: T-CORE-002
    description: "pyorbbecsdk ã‚’å¤–éƒ¨ä¾å­˜ã«åˆ‡ã‚Šæ›¿ãˆã€åå‰è¡çªã‚’å›é¿"
    depends_on: [P-CORE-002]
    steps:
      - "âœ… 1. `pyorbbecsdk` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ `vendor/pyorbbecsdk` ã¸ç§»å‹• (ä¸€æ™‚æªç½®)ã€‚"
      - "âœ… 2. `src` å†…ã® import ã‚’ `from vendor.pyorbbecsdk import ...` ã¸ä¸€æ‹¬ç½®æ›ã€‚"
      - "ğŸ”„ 3. requirements.txt ã«æ­£è¦ç‰ˆ pyorbbecsdk==2.0.10 ã‚’ pin ã—ã€vendor ç‰ˆã¯å°†æ¥çš„ã«å‰Šé™¤ã€‚"
    acceptance_criteria:
      - "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¨ CI ã§ import ç«¶åˆãŒç™ºç”Ÿã—ãªã„ã€‚"
    status: "PARTIALLY_COMPLETED"
    note: "vendor namespaceç§»å‹•å®Œäº†ã€requirements.txtã¯å¤–éƒ¨ç‰ˆå…¥æ‰‹å¾Œã«æ›´æ–°äºˆå®š"

  - id: T-CORE-003
    description: "ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’åˆ†é¡ã—å† raise æ–¹é‡ã‚’å®Ÿè£…"
    depends_on: [P-CORE-003]
    steps:
      - "âœ… 1. `src/input/stream.py` ã® `initialize`, `start`, `get_frame` ã‚’ SDK/ä¸€èˆ¬/è‡´å‘½ç³»ã§ `except` åˆ†å²ã€‚"
      - "âœ… 2. `src/input/pointcloud.py` ã® catch-all ã‚’ç‰¹å®šä¾‹å¤–ã«ç½®ãæ›ãˆã€ãƒ­ã‚°å¾Œã«å† raiseã€‚"
    acceptance_criteria:
      - "âœ… è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼æ™‚ã«ä¸Šä½ã§æ­£ã—ãä¾‹å¤–ãŒæ•æ‰ã§ãã€ãƒ†ã‚¹ãƒˆã§ç¢ºèªã§ãã‚‹ã€‚"
    status: "COMPLETED"

  - id: T-CORE-004
    description: "print â†’ logger ã¸ã®ç½®æ›"
    depends_on: [P-CORE-004]
    steps:
      - "âœ… 1. `src/input` ãŠã‚ˆã³ `src/detection` é…ä¸‹ã® print æ–‡ã‚’æ¤œç´¢ã—ã€logger å‘¼ã³å‡ºã—ã¸ç½®æ›ã€‚"
      - "ğŸ”„ 2. logger ã®ãƒ¬ãƒ™ãƒ«ã¯ debug ã§å†—é•·ãƒ­ã‚°ã€info ã§é€šå¸¸ãƒ­ã‚°ã¨ã™ã‚‹æŒ‡é‡ã‚’ README ã«è¿½è¨˜ã€‚"
    acceptance_criteria:
      - "âœ… æ¨™æº–å‡ºåŠ›ã«ãƒ‡ãƒãƒƒã‚°æ–‡å­—åˆ—ãŒå‡ºãªã„ã€‚ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²ã•ã‚Œã‚‹ã€‚"
    status: "PARTIALLY_COMPLETED"
    note: "print â†’ logger ç½®æ›å®Œäº†ã€READMEæ›´æ–°ã¯æ®‹ã‚¿ã‚¹ã‚¯"

  - id: T-CORE-005
    description: "ãƒ¡ãƒƒã‚·ãƒ¥ã‚°ãƒªãƒƒãƒ‰è¨ˆç®—ã®äºŒé‡åŒ–ã‚’è§£æ¶ˆ"
    depends_on: [P-CORE-005]
    steps:
      - "âœ… 1. `_precompute_meshgrid` ã¨ `_precompute_coefficients` ã‚’çµ±åˆæ¸ˆã¿ã€‚"
      - "âœ… 2. å‘¼ã³å‡ºã—ç®‡æ‰€ã‚’æ›´æ–°ã—ãƒ†ã‚¹ãƒˆã‚’é€šã™ã€‚"
    acceptance_criteria:
      - "âœ… åˆæœŸåŒ–æ™‚ã®ãƒ¡ãƒ¢ãƒªãƒ•ãƒƒãƒˆãƒ—ãƒªãƒ³ãƒˆãŒå‰Šæ¸›ã—ã€ãƒ†ã‚¹ãƒˆãŒ passã€‚"
    status: "COMPLETED"
    note: "æ—¢ã«çµ±åˆæ¸ˆã¿ã§é‡è¤‡è¨ˆç®—ã¯è§£æ¶ˆã•ã‚Œã¦ã„ã‚‹"

---
id: detection_refactor
title: "æ¤œå‡ºãƒ•ã‚§ãƒ¼ã‚ºãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°: å‹çµ±åˆãƒ»ä¾‹å¤–æ•´ç†ãƒ»mypy strict"
description: |
  `src/detection` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯é«˜æ©Ÿèƒ½ã ãŒå‹ã®ä¸€å…ƒç®¡ç†ãƒ»ä¾‹å¤–å®‰å…¨æ€§ãƒ»mypy strict å¯¾å¿œãŒä¸ååˆ†ã€‚
  ROI ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ”¹è‰¯ã‚„ OpenCV Tracker ã®æ›´æ–°ã‚‚å«ã‚ã€ä¿å®ˆæ€§ã¨ä¿¡é ¼æ€§ã‚’åº•ä¸Šã’ã™ã‚‹ã€‚
implementation_summary: |
  âœ… å®Ÿè£…å®Œäº† (2025-01-30):
  - å‹çµ±åˆ: HandednessType, HandLandmark, HandDetectionResultç­‰ã‚’src/types.pyã«çµ±åˆ
  - ä¾‹å¤–åˆ†é¡: MediaPipe/OpenCV/ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼ã§åˆ†é›¢ã€é©åˆ‡ãªãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š
  - sys.path hackå‰Šé™¤: å¾ªç’°ä¾å­˜è§£æ¶ˆã€é©åˆ‡ãªç›¸å¯¾importä½¿ç”¨
  - ç©ºæ¤œå‡ºæ™‚ã®ãƒˆãƒ©ãƒƒã‚«ãƒ¼æ›´æ–°ä¿®æ­£: lost_framesã‚«ã‚¦ãƒ³ãƒˆå•é¡Œè§£æ±º
  - 19æ¤œå‡ºãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹: ROIè¿½è·¡ã€ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
  ğŸ”„ éƒ¨åˆ†å®Œäº†: mypy strictå¯¾å¿œï¼ˆåŸºæœ¬çš„ãªå‹æ³¨é‡ˆè¿½åŠ æ¸ˆã¿ï¼‰
  ğŸ“‹ æ®‹ã‚¿ã‚¹ã‚¯: OpenCV deprecated APIæ›´æ–°ã€ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨åŒ–ã€å®Œå…¨ãªmypy strictå¯¾å¿œ
problems:
  - id: P-DET-001
    title: "Hand å‹ã‚¯ãƒ©ã‚¹ãŒå¤šé‡å®šç¾©"
    module: ["src/detection/hands2d.py", "src/detection/hands3d.py"]
    description: "HandednessType ç­‰ãŒ detection å†…ã«é–‰ã˜ã¦ãŠã‚Š src/types.py ã¨ä¹–é›¢ã€‚å¾ªç’°ä¾å­˜ã‚’èª˜ç™ºã€‚"
    severity: "High"
    fix_suggestion: "å…±é€šå‹ã‚’ src/types.py ã¸ç§»ã—ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ import ã§å‚ç…§ã™ã‚‹ã€‚"
  - id: P-DET-002
    title: "sys.path hack ã«ã‚ˆã‚‹å¾ªç’°ä¾å­˜"
    module: "src/detection/hands3d.py"
    description: "ç›¸å¯¾ãƒ‘ã‚¹è§£æ±ºã®ãŸã‚ sys.path.append ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ•´åˆæ€§ã‚’æã­ã‚‹ã€‚"
    severity: "High"
    fix_suggestion: "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç›¸å¯¾ import ã«ç½®æ›ã—ã€ä¸è¦ãª path æ“ä½œã‚’å‰Šé™¤ã€‚"
  - id: P-DET-003
    title: "catch-all ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ print ãƒ­ã‚°"
    module: ["src/detection/hands3d.py", "src/detection/hands2d.py"]
    description: "except Exception ã¨ print() ãŒæ··åœ¨ã—ã€é‡å¤§ã‚¨ãƒ©ãƒ¼ãŒã‚µã‚¤ãƒ¬ãƒ³ãƒˆã«æ¡ã‚Šæ½°ã•ã‚Œã‚‹ã€‚"
    severity: "Medium"
    fix_suggestion: "SDK/OpenCV/ValueError ç­‰ã§åˆ†é¡ã— logger.warning/error ã«çµ±ä¸€ã€è‡´å‘½ä¾‹å¤–ã¯å† raiseã€‚"
  - id: P-DET-004
    title: "mypy strict éå¯¾å¿œ"
    module: "src/detection/*"
    description: "Any å‹ã‚„æœªæ³¨é‡ˆå¼•æ•°ãŒå¤šæ•°ã€‚strict ãƒ¢ãƒ¼ãƒ‰ã§æ•°ç™¾ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚"
    severity: "Medium"
    fix_suggestion: "å…¨é–¢æ•°ãƒ»dataclass ã«å‹æ³¨é‡ˆã‚’è¿½åŠ ã—ã€Protocol ã§å¤–éƒ¨å‹ã‚’æŠ½è±¡åŒ–ã€‚"
  - id: P-DET-005
    title: "OpenCV Tracker ã®éæ¨å¥¨ API"
    module: "src/detection/hands2d.py"
    description: "TrackerKCF_create ã¯ OpenCV4.9 ã§deprecatedã€‚ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯ã®å¯èƒ½æ€§ã€‚"
    severity: "Low"
    fix_suggestion: "cv2.legacy.TrackerCSRT_create ã¸ç½®æ›ã— close() ã§è§£æ”¾ã€‚"
  - id: P-DET-006
    title: "ROI ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã®ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨æ€§"
    module: "src/detection/hands2d.py"
    description: "current_trackers dict ã¸ä¸¦åˆ—ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã« Lock ãŒãªã„ã€‚"
    severity: "Low"
    fix_suggestion: "threading.Lock ã§ä¿è­·ã—ç«¶åˆçŠ¶æ…‹ã‚’é˜²æ­¢ã€‚"
  - id: P-DET-007
    title: "å¾ªç’°ä¾å­˜ã«ã‚ˆã‚‹ import è¡çª"
    module: "src/detection/hands3d.py"
    description: "hands3d ãŒ hands2d ã‚’ import ã—ã€ã•ã‚‰ã« hands2d ãŒ hands3d å‹ã‚’å‚ç…§ã€‚"
    severity: "Medium"
    fix_suggestion: "å‹ã‚’ src/types.py ã«å¯„ã›ã¦ forward reference ã§è§£æ±ºã€‚"
  - id: P-DET-008
    title: "ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä¸è¶³"
    module: "tests/detection_test.py"
    description: "ROI skipãƒ»Kalman lost-track ãªã©ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãŒæœªãƒ†ã‚¹ãƒˆã€‚"
    severity: "Low"
    fix_suggestion: "pytest ã§çµ±è¨ˆå€¤ã¨çŠ¶æ…‹é·ç§»ã‚’æ¤œè¨¼ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã€‚"

tasks:
  - id: T-DET-001
    description: "Hand å‹ã‚¯ãƒ©ã‚¹ã® src/types.py ã¸ã®çµ±åˆã¨ import æ›´æ–°"
    depends_on: [P-DET-001, P-DET-002, P-DET-007]
    steps:
      - "âœ… 1. HandednessType, HandLandmark, HandDetectionResult ç­‰ã‚’ src/types.py ã¸ç§»å‹•ã€‚"
      - "âœ… 2. hands2d.py, hands3d.py, tracker.py ã®é‡è¤‡å®šç¾©ã‚’å‰Šé™¤ã€‚"
      - "âœ… 3. ç›¸å¯¾ import ã‚’ from ..types import ... ã«ç½®æ›ã€‚"
    acceptance_criteria:
      - "âœ… mypy strict ã§å‹é‡è¤‡ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã€‚"
    status: "COMPLETED"
  - id: T-DET-002
    description: "ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°åˆ†é¡ã¨ logger ç½®æ›"
    depends_on: [P-DET-003]
    steps:
      - "âœ… 1. print() ã‚’ logger.debug/info/warning/error ã«å…¨é¢ç½®æ›ã€‚"
      - "âœ… 2. except Exception â†’ ç‰¹å®šä¾‹å¤– + è‡´å‘½ä¾‹å¤–ã¯å† raiseã€‚"
    acceptance_criteria:
      - "âœ… è‡´å‘½ã‚¨ãƒ©ãƒ¼æ™‚ã«ä¸Šä½ã§ä¾‹å¤–æ•æ‰å¯èƒ½ã€‚ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡ãŒå¯èƒ½ã€‚"
    status: "COMPLETED"
  - id: T-DET-003
    description: "mypy strict å¯¾å¿œã¨ Protocol å°å…¥"
    depends_on: [P-DET-004]
    steps:
      - "ğŸ”„ 1. æœªæ³¨é‡ˆå¼•æ•°ãƒ»æˆ»ã‚Šå€¤ã¸å‹ã‚’è¿½åŠ ã€‚"
      - "ğŸ”„ 2. OpenCV Tracker ã®Protocolã‚’ typing_extensions ã§å®šç¾©ã€‚"
    acceptance_criteria:
      - "ğŸ”„ mypy strict ã§é‡å¤§ã‚¨ãƒ©ãƒ¼ã‚¼ãƒ­ã€‚"
    status: "IN_PROGRESS"
    note: "ä¸€éƒ¨ã®å‹æ³¨é‡ˆã‚’ä¿®æ­£ã—ãŸãŒã€å®Œå…¨ãªmypy strictå¯¾å¿œã¯æœªå®Œ"
  - id: T-DET-004
    description: "OpenCV Tracker æ›´æ–°ã¨ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾"
    depends_on: [P-DET-005]
    steps:
      - "ğŸ”„ 1. TrackerKCF_create â†’ legacy.TrackerCSRT_create ã¸å·®ã—æ›¿ãˆã€‚"
      - "ğŸ”„ 2. hands2d.close() ã§ tracker.clear() / del ã‚’å®Ÿè£…ã€‚"
    acceptance_criteria:
      - "ğŸ”„ é•·æ™‚é–“å®Ÿè¡Œã§ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ï¼FPS drop ãŒç™ºç”Ÿã—ãªã„ã€‚"
    status: "NOT_STARTED"
    note: "deprecated APIä¿®æ­£ã¯æ®‹ã‚¿ã‚¹ã‚¯"
  - id: T-DET-005
    description: "ROIãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã®ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨åŒ–"
    depends_on: [P-DET-006]
    steps:
      - "ğŸ”„ 1. threading.Lock ã‚’è¿½åŠ ã— current_trackers, current_rois ã‚’ä¿è­·ã€‚"
      - "ğŸ”„ 2. ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯å›é¿ã®ãŸã‚ lock ç²’åº¦ã‚’é–¢æ•°å˜ä½ã«é™å®šã€‚"
    acceptance_criteria:
      - "ğŸ”„ ä¸¦åˆ—ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„ã€‚"
    status: "NOT_STARTED"
    note: "ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨åŒ–ã¯æ®‹ã‚¿ã‚¹ã‚¯"
  - id: T-DET-006
    description: "æ¤œå‡ºãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæ‹¡å……"
    status: "COMPLETED"
    note: "28ãƒ†ã‚¹ãƒˆå…¨ã¦ãƒ‘ã‚¹ã€ååˆ†ãªã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’é”æˆ"
    depends_on: [P-DET-008]
    steps:
      - "1. ROI skip æ¯”ç‡ (>0.5) ã‚’ assert ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã€‚"
      - "2. Kalman lostâ†’terminated é·ç§»ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã‚¢ã‚µãƒ¼ãƒˆã€‚"
    acceptance_criteria:
      - "æ–°è¦ãƒ†ã‚¹ãƒˆãŒ pass ã—ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ +10% å‘ä¸Šã€‚"

---
id: mesh_refactor
title: "ãƒ¡ãƒƒã‚·ãƒ¥ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚ºãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°: Facade/Strategy + å‹çµ±ä¸€"
description: |
  src/mesh ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ API ä¸çµ±ä¸€ãƒ»äºŒé‡å®Ÿè£…ãƒ»å‹é‡è¤‡ãƒ»catch-all ä¾‹å¤–ãªã©æŠ€è¡“çš„è² å‚µãŒå¤šã„ã€‚
  MeshPipeline (Facade) ã¨ CPU/GPU Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å†è¨­è¨ˆã—ã€HeightMap/Mesh/SpatialIndex å‹ã‚’çµ±ä¸€ã™ã‚‹ã€‚
implementation_summary: |
  âœ… å®Ÿè£…å®Œäº† (2025-01-30):
  - å‹çµ±åˆ: HeightMap, Mesh, MeshSpatialIndexç­‰ã‚’src/types.pyã«çµ±åˆ
  - Facade Pattern: MeshPipelineã§ãƒ¯ãƒ³ã‚¹ãƒˆãƒƒãƒ—APIæä¾›ã€dirty-flagæœ€é©åŒ–
  - Strategy Pattern: UnifiedTriangulatorã§CPU/GPUçµ±ä¸€
  - ä¾‹å¤–åˆ†é¡: Memory/Data/Import/Generalä¾‹å¤–ã§åˆ†é›¢ã€é©åˆ‡ãªãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š
  - åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ: 28ãƒ†ã‚¹ãƒˆå®Ÿè£…ã€çµ±åˆãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ¤œè¨¼
  ğŸ”„ éƒ¨åˆ†å®Œäº†: simplify.py, attributes.py, å®Œå…¨ãªindex.pyçµ±åˆ
  ğŸ“‹ æ®‹ã‚¿ã‚¹ã‚¯: LODæœ€é©åŒ–ã€Numbaãƒ™ã‚¯ãƒˆãƒ«åŒ–ã€BVH/KDTreeæŠ½è±¡åŒ–
problems:
  - id: P-MESH-001
    title: "CPU/GPU äºŒé‡å®Ÿè£…ã¨ API ä¸çµ±ä¸€"
    module: ["src/mesh/delaunay.py", "src/mesh/delaunay_gpu.py"]
    severity: "High"
    description: "é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ç›¸é•ã«ã‚ˆã‚Šå‘¼ã³å‡ºã—å´ãŒå®Ÿè£…åˆ¥ã«åˆ†å²ã—ã¦ã„ã‚‹ã€‚"
  - id: P-MESH-002
    title: "ãƒ¡ãƒ¢ãƒªãƒ•ãƒƒãƒˆãƒ—ãƒªãƒ³ãƒˆãŒå¤§ãã„"
    module: ["src/mesh/projection.py", "src/mesh/lod_mesh.py"]
    severity: "High"
    description: "ãƒ•ãƒ«è§£åƒåº¦ HeightMap / LOD ã‚³ãƒ”ãƒ¼ã«ã‚ˆã‚Š >1GB ä½¿ç”¨ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã€‚"
  - id: P-MESH-003
    title: "catch-all ä¾‹å¤–ã¨ print ãƒ­ã‚°"
    module: "src/mesh/*"
    severity: "Medium"
    description: "except Exception ã¨ print() ãŒæ··åœ¨ã—ã€é‡å¤§ã‚¨ãƒ©ãƒ¼ãŒã‚µã‚¤ãƒ¬ãƒ³ãƒˆã«æ¡ã‚Šæ½°ã•ã‚Œã‚‹ã€‚"
  - id: P-MESH-004
    title: "ãƒ†ã‚¹ãƒˆ & mypy strict æœªå¯¾å¿œ"
    module: "src/mesh/*"
    severity: "Medium"
    description: "UnitTest ãŒç„¡ãã€strict ãƒ¢ãƒ¼ãƒ‰ã§æ•°ç™¾ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚"
  - id: P-MESH-005
    title: "è‡ªå‰ BVH å®Ÿè£…ã®æ€§èƒ½ãƒ»ç²¾åº¦ä¸æ˜"
    module: "src/mesh/index.py"
    severity: "Low"
    description: "SciPy KDTree ã‚ˆã‚Šé…ãã€è¡çªãƒ•ã‚§ãƒ¼ã‚ºã§ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚‹å¯èƒ½æ€§ã€‚"

tasks:
  - id: T-MESH-001
    description: "types.py ã« Mesh/HeightMap/SpatialIndex DataClass ã‚’å®Ÿè£…"
    depends_on: [P-MESH-004]
    status: "COMPLETED"  # âœ…
    note: "HeightMap, Mesh, MeshSpatialIndex, ProjectionMethod, MeshIndexTypeç­‰ã‚’çµ±åˆ"
  - id: T-MESH-002
    description: "projection.py ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã— create_height_map() ã‚’é«˜é€ŸåŒ–"
    depends_on: [P-MESH-001]
    status: "COMPLETED"  # âœ…
    note: "ä¾‹å¤–åˆ†é¡ãƒ»loggerç½®æ›ãƒ»types.pyçµ±åˆå®Œäº†"
  - id: T-MESH-003
    description: "triangulation.py ã§ CPU/GPU Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…"
    depends_on: [P-MESH-001]
    status: "COMPLETED"  # âœ…
    note: "UnifiedTriangulatorå®Ÿè£…ã€Strategy Enumã§æˆ¦ç•¥é¸æŠ"
  - id: T-MESH-004
    description: "pipeline.py ã« MeshPipeline Facade ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…"
    depends_on: [P-MESH-002]
    status: "COMPLETED"  # âœ…
    note: "Facade Pattern, dirty-flagæœ€é©åŒ–, ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½å®Ÿè£…"
  - id: T-MESH-005
    description: "attributes.py ã‚’ Numba ãƒ™ã‚¯ãƒˆãƒ«åŒ–"
    depends_on: [P-MESH-002]
    status: "NOT_STARTED"  # ğŸ“‹
    note: "æ³•ç·šè¨ˆç®—ã®åŸºæœ¬å®Ÿè£…ã®ã¿ã€Numbaæœ€é©åŒ–ã¯æ®‹ã‚¿ã‚¹ã‚¯"
  - id: T-MESH-006
    description: "index.py ã« BVH/KDTree æŠ½è±¡åŒ–ã‚’å®Ÿè£…"
    depends_on: [P-MESH-005]
    status: "NOT_STARTED"  # ğŸ“‹
    note: "åŸºæœ¬çš„ãªæ§‹é€ ä½“ã®ã¿ã€å®Œå…¨ãªæŠ½è±¡åŒ–ã¯æ®‹ã‚¿ã‚¹ã‚¯"
  - id: T-MESH-007
    description: "StatsCollector ã¨ä¾‹å¤–åˆ†é¡ã‚’å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å°å…¥"
    depends_on: [P-MESH-003]
    status: "COMPLETED"  # âœ…
    note: "delaunay.pyç­‰ã§ä¾‹å¤–åˆ†é¡ãƒ»loggerç½®æ›å®Œäº†"
  - id: T-MESH-008
    description: "tests/mesh_test.py ã‚’å®Ÿè£…ã—å…¨å·¥ç¨‹ã‚’ã‚«ãƒãƒ¼"
    depends_on: [P-MESH-004]
    status: "COMPLETED"  # âœ…
    note: "åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè£…ã€çµ±åˆãƒ†ã‚¹ãƒˆå«ã‚€"

id: collision_refactor
version: "1.0"
title: "è¡çªãƒ•ã‚§ãƒ¼ã‚ºãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°: å‹æ•´åˆãƒ»ãƒ­ã‚®ãƒ³ã‚°çµ±ä¸€ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¿®æ­£"
owner: "dev-team"
created: "2025-06-29"
description: |
  collision ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ NumPy/Numba ã‚’é§†ä½¿ã—ãŸæ„æ¬²çš„ãªé«˜é€ŸåŒ–å®Ÿè£…ã ãŒã€
  mesh ãƒªãƒ•ã‚¡ã‚¯ã‚¿å¾Œã®å‹ä¸æ•´åˆãƒ»ãƒ­ã‚¬ãƒ¼æœªå®šç¾©ãƒ»éå‰°æœ€é©åŒ–ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆå¤±æ•—ãŒé¡•åœ¨åŒ–ã—ã¦ã„ã‚‹ã€‚
  æœ¬ã‚¿ã‚¹ã‚¯ã§ã¯åŸºç›¤æ•´åˆæ€§ (å‹ï¼ãƒ­ã‚®ãƒ³ã‚°ï¼ãƒ•ãƒ©ã‚°) ã‚’æœ€å„ªå…ˆã«ä¿®æ­£ã—ã€
  ãã®å¾Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ãŠã‚ˆã³ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«ã®å®ŸåŠ¹æ€§ã‚’å†è©•ä¾¡ã™ã‚‹ã€‚

problems:
  - id: P-COL-001
    title: "SpatialIndex å‹åä¸ä¸€è‡´"
    severity: "High"
    description: |
      mesh ãƒ•ã‚§ãƒ¼ã‚ºã§ SpatialIndex â†’ MeshSpatialIndex ã¸ãƒªãƒãƒ¼ãƒ ã—ãŸãŒã€
      collision/search.py ç­‰ã¯æ—§åã‚’ import ã—ã¦ãŠã‚Šå®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã€‚
  - id: P-COL-002
    title: "ãƒ­ã‚¬ãƒ¼æœªå®šç¾© / NameError"
    severity: "High"
    description: |
      search.py, events.py ãªã©ã§ logger å‚ç…§ãŒæ¼ã‚Œã€ãƒ†ã‚¹ãƒˆã§ NameError ãŒç™ºç”Ÿã€‚
  - id: P-COL-003
    title: "NUMBA_AVAILABLE ãƒ•ãƒ©ã‚°æ¬ è½"
    severity: "Medium"
    description: |
      performance_vectorized ãƒ†ã‚¹ãƒˆãŒ patch å¯¾è±¡ãƒ•ãƒ©ã‚°ã‚’æ¢ã™ãŒ distance/vectorized ã«æœªå®šç¾©ã§ AttributeErrorã€‚
  - id: P-COL-004
    title: "éåº¦ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆåŸºæº–ã¨ JIT ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ¼ã‚Œ"
    severity: "Medium"
    description: |
      è·é›¢è¨ˆç®— 0.001ms/è¨ˆç®—ãªã©éç¾å®Ÿçš„ã€‚åˆå› JIT ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚é–“ã‚‚å«ã¾ã‚Œã¦ãŠã‚Šãƒ†ã‚¹ãƒˆãŒæ’å¸¸çš„ã«å¤±æ•—ã€‚
  - id: P-COL-005
    title: "ä¾å­˜å¯†åº¦éå¤šã¨å¾ªç’°ãƒªã‚¹ã‚¯"
    severity: "Low"
    description: |
      search.py ãŒ config/mesh/detection ç­‰ã¸å¤šé‡ä¾å­˜ã€‚ DI ã§è§£æ±ºã™ã¹ãã€‚
  - id: P-COL-006
    title: "ä¾‹å¤–åˆ†é¡ãŒæ›–æ˜§"
    severity: "Low"
    description: |
      Numba, MemoryError, ValueError ãªã©ã‚’ä¸€æ‹¬ catch ã—ã¦ã—ã¾ã„ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£ã€‚

tasks:
  - id: T-COL-001
    title: "å‹æ•´åˆ: SpatialIndex â†’ MeshSpatialIndex ã¸æ›´æ–°"
    depends_on: [P-COL-001]
    status: "PENDING"
    steps:
      - "search.py, sphere_tri.py, events.py ç­‰ã® import ã‚’æ›´æ–°"
      - "types.py ã¸ SearchResult, SearchStrategy ã‚’æ­£å¼å®šç¾©ã—ã¦å‚ç…§"
    acceptance_criteria:
      - "mypy/pytest ã§å‹ã‚¨ãƒ©ãƒ¼ãƒ»ImportError ãŒç™ºç”Ÿã—ãªã„"

  - id: T-COL-002
    title: "ãƒ­ã‚¬ãƒ¼çµ±ä¸€ & print å»ƒæ­¢"
    depends_on: [P-COL-002, P-COL-006]
    status: "PENDING"
    steps:
      - "å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ get_logger(__name__) ã‚’ä½¿ç”¨"
      - "logger.debug/info/warning/error ã«ãƒ¬ãƒ™ãƒ«åˆ†å‰²"
      - "MemoryError/ValueError/ImportError ã¯å† raise"
    acceptance_criteria:
      - "NameError: logger ãŒä¸€åˆ‡å‡ºãªã„"

  - id: T-COL-003
    title: "NUMBA_AVAILABLE ãƒ•ãƒ©ã‚°å°å…¥"
    depends_on: [P-COL-003]
    status: "PENDING"
    steps:
      - "distance.py, distance_gpu.py, vectorized.py ã§ NUMBA_AVAILABLE ã‚’å®šç¾©"
      - "ãƒ†ã‚¹ãƒˆ monkeypatch å¯¾å¿œç¢ºèª"
    acceptance_criteria:
      - "AttributeError: NUMBA_AVAILABLE ãŒå‡ºãªã„"

  - id: T-COL-004
    title: "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–¾å€¤ã¨ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—èª¿æ•´"
    depends_on: [P-COL-004]
    status: "PENDING"
    steps:
      - "ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å´ã®é–¾å€¤ã‚’å®Ÿæ¸¬ãƒ™ãƒ¼ã‚¹ã«å†è¨­å®š"
      - "distance.* ã« warmup() é–¢æ•°ã‚’è¿½åŠ ã— JIT åˆå›ã‚’é™¤å¤–"
    acceptance_criteria:
      - "performance_vectorized, performance_unified ãƒ†ã‚¹ãƒˆãŒ pass"

  - id: T-COL-005
    title: "ä¾å­˜æ€§ã®ç°¡ç´ åŒ–ã¨ DI å¯¾å¿œ"
    depends_on: [P-COL-005]
    status: "PENDING"
    steps:
      - "CollisionSearcher ã« config ã‚’æ¸¡ã™ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ã‚’è¿½åŠ  (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ None)"
      - "ãƒ†ã‚¹ãƒˆã§ãƒ¢ãƒƒã‚¯è¨­å®šã‚’æ³¨å…¥å¯èƒ½ã«"
    acceptance_criteria:
      - "æ¤œç´¢ã‚¯ãƒ©ã‚¹ã‚’å˜ä½“ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦ã‚‚å¾ªç’° import ãŒç„¡ã„"

  - id: T-COL-006
    title: "ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæ›´æ–° & ã‚«ãƒãƒ¬ãƒƒã‚¸ä¿è¨¼"
    depends_on: [T-COL-001, T-COL-002, T-COL-003, T-COL-004]
    status: "PENDING"
    steps:
      - "æ—¢å­˜ collision ãƒ†ã‚¹ãƒˆã‚’æ–° API ã«åˆã‚ã›ã¦æ›´æ–°"
      - "missing branch ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ  (face_culling on/off ç­‰)"
    acceptance_criteria:
      - "tests/collision_test.py ç³»ãŒå…¨ pass"

implementation_notes: |
  â€¢ åŸºç›¤æ•´åˆ (T-COL-001ã€œ003) ã‚’æœ€å„ªå…ˆã§è§£æ±ºã—ã€æ—¢å­˜ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’ã‚¼ãƒ­ã«ã™ã‚‹ã€‚
  â€¢ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã¯å®Ÿæ¸¬å€¤ +15% ãƒãƒ¼ã‚¸ãƒ³ã§å†è¨­å®šã—ã€JIT ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ™‚é–“ã‚’é™¤å¤–ã€‚
  â€¢ ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«æœ€é©åŒ–ã¯ feature_flag=true ã§æœ‰åŠ¹ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç„¡åŠ¹åŒ–ã—ã¦ãƒã‚°å½±éŸ¿ã‚’é™å®šã€‚

---
id: sound_refactor
version: "1.0"
title: "éŸ³éŸ¿ãƒ•ã‚§ãƒ¼ã‚ºãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°: ãƒ­ã‚®ãƒ³ã‚°çµ±ä¸€ãƒ»è¨­è¨ˆåˆ†å‰²ãƒ»ãƒ†ã‚¹ãƒˆè¿½åŠ "
owner: "dev-team"
created: "2025-06-29"
description: |
  sound ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ mapping â†’ synth â†’ voice_mgr ã®ä¸‰å±¤æ§‹é€ ã§è¨­è¨ˆæ€æƒ³ã¯å„ªã‚Œã‚‹ã‚‚ã®ã®ã€
  600 è¡Œè¶…ã®å·¨å¤§ã‚¯ãƒ©ã‚¹ãƒ»ç²—ã„ãƒ­ãƒƒã‚¯ç²’åº¦ãƒ»print/ logger æ··åœ¨ãƒ»ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæ¬ å¦‚ç­‰ãŒä¿å®ˆæ€§ã¨
  ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§èƒ½ã‚’é˜»å®³ã—ã¦ã„ã‚‹ã€‚æœ¬ã‚¿ã‚¹ã‚¯ã§ã¯è¨­è¨ˆåˆ†å‰²ã¨åŸºç›¤æ”¹å–„ã‚’è¡Œã„ã€å°†æ¥ã®æ©Ÿèƒ½è¿½åŠ ã«
  è€ãˆã†ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ã¸åˆ·æ–°ã™ã‚‹ã€‚

problems:
  - id: P-SND-001
    title: "ãƒ­ã‚®ãƒ³ã‚°ã¨ print() æ··åœ¨"
    severity: "High"
    description: |
      synth.py å†…ã§ print() ãŒæ®‹å­˜ã—ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡ä¸å¯ã€‚ã‚¨ãƒ©ãƒ¼æ™‚ã® stacktrace ã‚‚æ¬ è½ã€‚
  - id: P-SND-002
    title: "ã‚¯ãƒ©ã‚¹è‚¥å¤§åŒ–ã¨ Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³æ¬ å¦‚"
    severity: "Medium"
    description: |
      _create_instrument_template/_create_voice ãŒ if-else ã§ 300 è¡Œä»¥ä¸Šã€‚Instrument ã‚¯ãƒ©ã‚¹åŒ–ãŒå¿…è¦ã€‚
  - id: P-SND-003
    title: "ãƒ­ãƒƒã‚¯ç²’åº¦ãŒç²—ãã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆåŠ£åŒ–"
    severity: "Medium"
    description: |
      AudioSynthesizer ã¨ VoiceManager ãŒã‚¯ãƒ©ã‚¹å…¨ä½“ã‚’ mutex ã§å›²ã¿ã€ãƒãƒªãƒ•ã‚©ãƒ‹ãƒ¼å¢—ã§ã‚¹ã‚±ãƒ¼ãƒ«ã—ãªã„ã€‚
  - id: P-SND-004
    title: "ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ/ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¬ å¦‚"
    severity: "High"
    description: |
      pyo ãŒ CI ã§ãƒ“ãƒ«ãƒ‰ã§ããªã„ãŸã‚ NullBackend å¿…é ˆã€‚ç¾åœ¨ã¯ AttributeError ã®ãƒªã‚¹ã‚¯ã‚ã‚Šã€‚
  - id: P-SND-005
    title: "DSP ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯"
    severity: "Low"
    description: |
      mapping.py ãŒæ¯ãƒ•ãƒ¬ãƒ¼ãƒ  pow/ sin ã‚’å‘¼ã³ CPU ä½¿ç”¨ç‡å¢—ã€‚LUT åŒ–ã¾ãŸã¯ numba å¯¾å¿œãŒå¿…è¦ã€‚
  - id: P-SND-006
    title: "ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰è¨­å®šã¨ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ä¸èƒ½"
    severity: "Low"
    description: |
      æ¥½å™¨ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ»ã‚¹ã‚±ãƒ¼ãƒ«å®šç¾©ãŒã‚³ãƒ¼ãƒ‰å†…å›ºå®šã€‚YAML å¤–éƒ¨åŒ–ã—ãƒ©ã‚¤ãƒ–æ›´æ–°ã‚’å¯èƒ½ã«ã™ã‚‹ã€‚

tasks:
  - id: T-SND-001
    title: "ãƒ­ã‚®ãƒ³ã‚°çµ±ä¸€ & print å»ƒæ­¢"
    depends_on: [P-SND-001]
    status: "PENDING"
    steps:
      - "synth.py / voice_mgr.py ã® print() ã‚’ logger ã«ç½®æ›"
      - "logger.exception ã§ stacktrace ã‚’å‡ºåŠ›"
    acceptance_criteria:
      - "grep -R "print(" src/sound | wc -l == 0"

  - id: T-SND-002
    title: "Instrument Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³å°å…¥"
    depends_on: [P-SND-002]
    status: "PENDING"
    steps:
      - "synth/instruments/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ–°è¦ä½œæˆã— InstrumentBase ã‚’å®šç¾©"
      - "ãƒãƒªãƒ³ãƒãƒ»ãƒ‘ãƒƒãƒ‰ç­‰ã‚’ã‚¯ãƒ©ã‚¹å®Ÿè£…ã— _create_instrument_template ã‚’æ’¤å»"
    acceptance_criteria:
      - "mypy strict ãŒé€šéã€ã‚³ãƒ¼ãƒ‰è¡Œæ•° synth.py -20%"

  - id: T-SND-003
    title: "ãƒ­ãƒƒã‚¯ç²’åº¦æœ€é©åŒ–"
    depends_on: [P-SND-003]
    status: "PENDING"
    steps:
      - "VoiceManager ã‚’ heapq + RWLock ã«ç½®æ›"
      - "AudioSynthesizer.play_audio_parameters ã§ voice å˜ä½ã® lock ã«å¤‰æ›´"
    acceptance_criteria:
      - "100 åŒæ™‚ãƒœã‚¤ã‚¹æ™‚ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ +30%"

  - id: T-SND-004
    title: "NullBackend ã¨ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆè¿½åŠ "
    depends_on: [P-SND-004]
    status: "PENDING"
    steps:
      - "backend/null_backend.py ã‚’å®Ÿè£…ã— pyo ä¸åœ¨ã§ã‚‚å‹•ä½œ"
      - "pytest ã§ mapperâ†’synthâ†’voice_mgr ã® E2E ãƒ†ã‚¹ãƒˆä½œæˆ"
    acceptance_criteria:
      - "CI (no-pyo env) ã§ã™ã¹ã¦ã® sound ãƒ†ã‚¹ãƒˆãŒ pass"

  - id: T-SND-005
    title: "DSP ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ†ãƒ¼ãƒ–ãƒ«åŒ– / numba æœ€é©åŒ–"
    depends_on: [P-SND-005]
    status: "PENDING"
    steps:
      - "mapping._map_velocity ç­‰ã®é‡ã„é–¢æ•°ã‚’ LUT or njit åŒ–"
      - "ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ CPU ä½¿ç”¨ç‡ -20%"
    acceptance_criteria:
      - "tests/sound_test.py ãŒ passã€benchmark æ”¹å–„ã‚’ç¢ºèª"

  - id: T-SND-006
    title: "è¨­å®š YAML å¤–éƒ¨åŒ– & ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰"
    depends_on: [P-SND-006]
    status: "PENDING"
    steps:
      - "config/sound_presets.yaml ã«ã‚¹ã‚±ãƒ¼ãƒ« / æ¥½å™¨ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ç§»å‹•"
      - "ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ watchdog ã§ç›£è¦–ã—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å†èª­è¾¼"
    acceptance_criteria:
      - "ãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´å¾Œ 1s ä»¥å†…ã«åæ˜ "

implementation_notes: |
  â€¢ SND-001,002 ã‚’å…ˆè¡Œã—ãƒ†ã‚¹ãƒˆåŸºç›¤ã‚’æ•´å‚™ã€‚æ¬¡ã« SND-004 ã§ NullBackend ã‚’å°å…¥ã— CI é€šéã‚’ç¢ºä¿ã€‚
  â€¢ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç³» (SND-003,005) ã¯å¾Œç¶šã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿæ¸¬ãƒ™ãƒ¼ã‚¹ã§æœ€é©åŒ–ã€‚
  â€¢ å¤–éƒ¨åŒ– (SND-006) ã¯ JSON5 / YAML ã„ãšã‚Œã‹æ¡ç”¨ã—ã€å†ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚‚ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€‚
