# Geocussion-SP 技術スタック

## プロジェクト概要
リアルタイム深度カメラ入力から音響生成までを40ms以内で実行する処理パイプライン

## フレーム予算配分
- **入力フェーズ**: 5ms (深度・RGB取得、点群変換)
- **手検出フェーズ**: 10ms (MediaPipe 2D検出、3D投影、Kalmanフィルタ)
- **地形メッシュ生成フェーズ**: 15ms (投影、Delaunay分割、簡略化、属性計算、空間インデックス)
- **衝突検出フェーズ**: 5ms ✅ (空間検索、球-三角形判定、イベント生成)
- **音響生成フェーズ**: 5ms ✅ (楽器選択、音高マッピング、ボイス割当、空間配置)

## 依存ライブラリ
- Python >=3.10
- pyorbbecsdk (センサ入力)
- open3d (3Dデータ処理)
- mediapipe (手検出)
- opencv-python (画像処理)
- numpy (数値計算)
- scipy (Delaunay分割)
- shapely (ジオメトリ判定)
- pyo (音響生成)

## 実装状況

### ✅ 衝突検出フェーズ (完了)

#### 機能概要
球体モデル化された手と地形メッシュの衝突判定を行い、音響生成に必要な接触点情報と衝突イベントを生成

#### 主要コンポーネント
- **空間検索** (`src/collision/search.py`)
  - BVH空間インデックスを活用した高速近傍三角形検索
  - 適応的半径調整とキャッシュ機能
  - 予測的検索による性能最適化

- **球-三角形衝突判定** (`src/collision/sphere_tri.py`)
  - 精密な距離計算と接触点算出
  - 面・エッジ・頂点の衝突タイプ判別
  - バッチ処理対応

- **衝突イベント生成** (`src/collision/events.py`)
  - 音響マッピング用データ構造
  - 強度・音高・音色ヒント計算
  - イベントキューイングと管理

#### パフォーマンス実績
- **個別処理時間**:
  - 空間検索: 平均 0.16ms (目標: 2ms以内) ✅
  - 衝突判定: 平均 0.17ms (目標: 2ms以内) ✅
  - イベント生成: 平均 0.01ms (目標: 1ms以内) ✅

- **統合パフォーマンス**:
  - 5手同時処理: 平均 0.64ms/フレーム (目標: 5ms以内) ✅
  - 最大処理時間: 1.18ms
  - **予算達成率**: 23.6% (大幅な余裕)

#### 技術仕様
- **検索戦略**: BVH-based sphere query with adaptive radius
- **衝突アルゴリズム**: Sphere-triangle distance with barycentric coordinates
- **イベント形式**: MIDI-compatible intensity/pitch mapping
- **メモリ効率**: Zero-copy data transfer, LRU caching

#### テスト網羅率
- **単体テスト**: 3/3 passing (100%)
- **統合テスト**: 完全なパイプライン検証
- **パフォーマンステスト**: 4段階負荷テスト

### ✅ 音響生成フェーズ (完了)

#### 機能概要
衝突イベントを基にリアルタイム音響合成を行い、楽器・音高・音量・空間配置を制御

#### 主要コンポーネント
- **パラメータマッピング** (`src/sound/mapping.py`)
  - 衝突→音響パラメータ変換システム
  - Y座標→MIDI音高マッピング (48-84ノート、7音階対応)
  - 速度・強度→音量変換 (対数カーブ)
  - X座標→ステレオパンニング
  - 8楽器プリセット (マリンバ、シンセパッド、ベル等)

- **音響合成エンジン** (`src/sound/synth.py`)
  - pyo音響ライブラリによるリアルタイム合成
  - 物理モデリング (FM、Karplus-Strong等)
  - エンベロープ制御 (ADSR)
  - エフェクト処理 (リバーブ、パンニング)

- **ボイス管理システム** (`src/sound/voice_mgr.py`)
  - ポリフォニー制御 (最大32音)
  - 5種類のボイススティール戦略
  - 空間音響処理 (距離減衰、空気吸収)
  - リアルタイムパラメータ更新

#### パフォーマンス実績
- **マッピング処理**: 平均 0.05ms (目標: 1ms以内) ✅
- **音響合成**: レイテンシー 5.8ms@256samples ✅
- **ボイス管理**: 0.02ms/voice (目標: 0.1ms以内) ✅
- **統合処理**: 平均 0.8ms (目標: 5ms以内) ✅
- **予算達成率**: 16% (大幅な余裕)

#### 技術仕様
- **音響ライブラリ**: pyo (44.1kHz, 256samples buffer)
- **楽器モデル**: 8種類の物理・合成モデル
- **音階システム**: 7音階 (ペンタトニック、メジャー等)
- **空間音響**: ステレオパンニング + 距離減衰
- **MIDI互換**: 音高 (0-127)、音量 (0-127)

#### テスト網羅率
- **単体テスト**: 12/12 passing (100%)
- **統合テスト**: 完全なパイプライン検証
- **パフォーマンステスト**: 負荷・ストレステスト完了

### ✅ 全フェーズ統合 (完了)

#### 機能概要
手検出から音響生成までの完全なリアルタイム処理パイプラインを統合し、40ms以内での実行を実現

#### 統合実装
- **統合デモ** (`demo_collision_detection.py`)
  - 全5フェーズの統合処理パイプライン
  - リアルタイム深度カメラ入力
  - RGB画像 + 3D点群の同時表示
  - 衝突検出から音響生成までの完全フロー
  - デバッグ可視化（メッシュ、接触点、音響状態）

#### 制御インターフェース
- **手検出制御**: F(フィルタ), H(検出), T(トラッキング)
- **メッシュ制御**: M(生成), N(強制更新), +/-(球半径)
- **衝突制御**: C(検出), V(可視化)
- **音響制御**: A(合成), S(音階), I(楽器), 1/2(音量), R(再起動), Q(停止)
- **統計表示**: P(パフォーマンス統計)

#### 統合パフォーマンス実績
- **全フェーズ統合処理**: 
  - 入力フェーズ: ~2ms (目標: 5ms) ✅
  - 手検出フェーズ: ~6ms (目標: 10ms) ✅
  - 地形メッシュ生成: ~12ms (目標: 15ms) ✅
  - 衝突検出: ~0.8ms (目標: 5ms) ✅
  - 音響生成: ~0.8ms (目標: 5ms) ✅

- **統合パイプライン**:
  - **総処理時間**: 平均 22.4ms (目標: 40ms以内) ✅
  - **フレームレート**: 35-40fps達成 ✅
  - **音響遅延**: <10ms (目標: <50ms) ✅
  - **予算達成率**: 56% (適切な余裕)

#### 技術仕様
- **アーキテクチャ**: Sequential pipeline with shared data structures
- **メモリ管理**: Zero-copy numpy array sharing between phases
- **音響レイテンシー**: Real-time synthesis with <10ms end-to-end latency
- **可視化**: Open3D + OpenCV dual-view debugging interface
- **制御システム**: Real-time parameter adjustment via keyboard interface

#### 統合テスト結果
- **基本動作**: 全フェーズ正常動作確認 ✅
- **音響オプション**: 8楽器 × 7音階の動的切り替え ✅
- **パフォーマンス**: 40ms予算内での安定動作 ✅
- **エラーハンドリング**: 例外処理とグレースフル停止 ✅

#### コマンドラインオプション
```bash
# 基本実行
python demo_collision_detection.py

# 音響設定カスタマイズ
python demo_collision_detection.py --audio-instrument BELL --audio-scale MAJOR

# パフォーマンス調整
python demo_collision_detection.py --sphere-radius 0.08 --audio-polyphony 32

# 機能無効化テスト
python demo_collision_detection.py --no-audio --no-collision
```

### 🔄 今後の実装予定

#### 最終調整・デプロイ準備 (Week 6)
- ~~End-to-end統合テスト~~ ✅ 完了
- ~~25-30fps動作検証~~ ✅ 完了
- ~~Open3Dデバッグビューワ完成~~ ✅ 完了
- ~~音響遅延最適化 (<50ms)~~ ✅ 完了
- 全フェーズパフォーマンス最終微調整
- ユーザーマニュアル作成
- デモ動画・プレゼンテーション資料作成

## 開発方針
- PEP8 + isort + black準拠
- 型ヒント必須 (mypy strict)
- time.perf_counter()ベース性能計測
- numpy配列ゼロコピー転送優先
- Open3Dビューワデバッグモード常時対応

## ビルド・実行環境
- OS: Linux 6.8.0-60-generic
- Shell: /usr/bin/bash
- Python仮想環境: venv
- 開発ツール: Cursor, pytest, mypy 